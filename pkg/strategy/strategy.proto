syntax = "proto3";

package strategy;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

option go_package = "github.com/sirily11/argo-trading-go/pkg/strategy";

// MarketData represents the market data for a single point in time
message MarketData {
  string symbol = 1;
  double high = 2;
  double low = 3;
  double open = 4;
  double close = 5;
  double volume = 6;
  google.protobuf.Timestamp time = 7;
}

// TradingStrategy defines the interface for trading strategies
// go:plugin type=plugin version=1
service TradingStrategy {
  // Initialize sets up the strategy with a configuration string
  rpc Initialize(InitializeRequest) returns (google.protobuf.Empty) {}
  // ProcessData processes new market data and generates signals
  rpc ProcessData(ProcessDataRequest) returns (google.protobuf.Empty) {}
  // Name returns the name of the strategy
  rpc Name(NameRequest) returns (NameResponse) {}
  // GetConfigSchema returns the schema of the strategy configuration
  rpc GetConfigSchema(GetConfigSchemaRequest) returns (GetConfigSchemaResponse) {}
  // GetDescription returns a description of the strategy
  rpc GetDescription(GetDescriptionRequest) returns (GetDescriptionResponse) {}
  // GetIdentifier returns the unique identifier for the strategy (e.g., "com.example.strategy")
  rpc GetIdentifier(GetIdentifierRequest) returns (GetIdentifierResponse) {}
}

message GetConfigSchemaRequest {}

message GetConfigSchemaResponse {
  string schema = 1;
}

message GetDescriptionRequest {}

message GetDescriptionResponse {
  string description = 1;
}

message InitializeRequest {
  // config is the configuration for the strategy in JSON format
  string config = 1;
}

// ProcessDataRequest contains the market data to process
message ProcessDataRequest {
  MarketData data = 1;
}

// NameRequest is an empty request for getting the strategy name
message NameRequest {}

// NameResponse contains the strategy name
message NameResponse {
  string name = 1;
}

// GetIdentifierRequest is an empty request for getting the strategy identifier
message GetIdentifierRequest {}

// GetIdentifierResponse contains the strategy identifier
message GetIdentifierResponse {
  // Unique identifier for the strategy (e.g., "com.example.strategy.sma")
  string identifier = 1;
}

// StrategyApi defines all the functions that the host provides to the plugin
// go:plugin type=host
service StrategyApi {
  // DataSource methods
  rpc GetRange(GetRangeRequest) returns (GetRangeResponse) {}
  rpc ReadLastData(ReadLastDataRequest) returns (MarketData) {}
  rpc ExecuteSQL(ExecuteSQLRequest) returns (ExecuteSQLResponse) {}
  rpc Count(CountRequest) returns (CountResponse) {}

  // Indicator methods
  rpc ConfigureIndicator(ConfigureRequest) returns (google.protobuf.Empty) {}
  rpc GetSignal(GetSignalRequest) returns (GetSignalResponse) {}

  // Cache methods
  rpc GetCache(GetRequest) returns (GetResponse) {}
  rpc SetCache(SetRequest) returns (google.protobuf.Empty) {}

  // TradingSystem methods
  rpc PlaceOrder(ExecuteOrder) returns (google.protobuf.Empty) {}
  rpc PlaceMultipleOrders(PlaceMultipleOrdersRequest) returns (google.protobuf.Empty) {}
  rpc GetPositions(google.protobuf.Empty) returns (GetPositionsResponse) {}
  rpc GetPosition(GetPositionRequest) returns (Position) {}
  rpc CancelOrder(CancelOrderRequest) returns (google.protobuf.Empty) {}
  rpc CancelAllOrders(google.protobuf.Empty) returns (google.protobuf.Empty) {}
  rpc GetOrderStatus(GetOrderStatusRequest) returns (GetOrderStatusResponse) {}
  rpc GetAccountInfo(google.protobuf.Empty) returns (AccountInfo) {}
  rpc GetOpenOrders(google.protobuf.Empty) returns (GetOpenOrdersResponse) {}
  rpc GetTrades(GetTradesRequest) returns (GetTradesResponse) {}

  // Marker methods
  rpc Mark(MarkRequest) returns (google.protobuf.Empty) {}
  rpc GetMarkers(google.protobuf.Empty) returns (GetMarkersResponse) {}

  // Logging methods
  rpc Log(LogRequest) returns (google.protobuf.Empty) {}
}

enum Interval {
  INTERVAL_1M = 0;
  INTERVAL_5M = 1;
  INTERVAL_15M = 2;
  INTERVAL_30M = 3;
  INTERVAL_1H = 4;
  INTERVAL_4H = 5;
  INTERVAL_6H = 6;
  INTERVAL_8H = 7;
  INTERVAL_12H = 8;
  INTERVAL_1D = 9;
  INTERVAL_1W = 10;
  INTERVAL_1MONTH = 11;
}

enum PositionType {
  POSITION_TYPE_LONG = 0;
  POSITION_TYPE_SHORT = 1;
}

message GetRangeRequest {
  string symbol = 1;
  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
  Interval interval = 4;
}

message GetRangeResponse {
  repeated MarketData data = 1;
}

message ReadLastDataRequest {
  string symbol = 1;
}

message ExecuteSQLRequest {
  string query = 1;
  repeated string params = 2;
}

message SQLResult {
  map<string, string> fields = 1;
}

message ExecuteSQLResponse {
  repeated SQLResult results = 1;
}

message CountRequest {
  google.protobuf.Timestamp start_time = 1;
  google.protobuf.Timestamp end_time = 2;
}

message CountResponse {
  int32 count = 1;
}

message ConfigureRequest {
  IndicatorType indicator_type = 1;
  string config = 2;
}

message GetSignalRequest {
  IndicatorType indicator_type = 1;
  MarketData market_data = 2;
}

message GetSignalResponse {
  google.protobuf.Timestamp timestamp = 1;
  SignalType type = 2;
  string name = 3;
  string reason = 4;
  string rawValue = 5;
  string symbol = 6;
  IndicatorType indicatorType = 7;
}

enum SignalType {
  SIGNAL_TYPE_BUY_LONG = 0;
  SIGNAL_TYPE_SELL_LONG = 1;
  SIGNAL_TYPE_BUY_SHORT = 2;
  SIGNAL_TYPE_SELL_SHORT = 3;
  SIGNAL_TYPE_NO_ACTION = 4;
  SIGNAL_TYPE_CLOSE_POSITION = 5;
  SIGNAL_TYPE_WAIT = 6;
  SIGNAL_TYPE_ABORT = 7;
}

enum IndicatorType {
  // RSI (Relative Strength Index)
  // Config: [period, rsiLowerThreshold?, rsiUpperThreshold?] - e.g., "[14]" or "[14, 30, 70]"
  // Defaults: period=14, rsiLowerThreshold=30, rsiUpperThreshold=70
  // RawValue: {"rsi": float64} - RSI value (0-100 scale)
  INDICATOR_RSI = 0;

  // MACD (Moving Average Convergence Divergence)
  // Config: [fastPeriod, slowPeriod, signalPeriod] - e.g., "[12, 26, 9]"
  // Defaults: fastPeriod=12, slowPeriod=26, signalPeriod=9
  // RawValue: {"macd": float64} - MACD line value
  INDICATOR_MACD = 1;

  // Bollinger Bands
  // Config: [period, stdDev, lookback] - e.g., "[20, 2.0, \"24h\"]"
  // Defaults: period=20, stdDev=2.0, lookback="24h"
  // RawValue: {"upper": float64, "middle": float64, "lower": float64}
  INDICATOR_BOLLINGER_BANDS = 2;

  // Stochastic Oscillator (NOT IMPLEMENTED)
  INDICATOR_STOCHASTIC_OSCILLATOR = 3;

  // Williams %R (NOT IMPLEMENTED)
  INDICATOR_WILLIAMS_R = 4;

  // ADX - Average Directional Index (NOT IMPLEMENTED)
  INDICATOR_ADX = 5;

  // CCI - Commodity Channel Index (NOT IMPLEMENTED)
  INDICATOR_CCI = 6;

  // AO - Awesome Oscillator (NOT IMPLEMENTED)
  INDICATOR_AO = 7;

  // Trend Strength (NOT IMPLEMENTED)
  INDICATOR_TREND_STRENGTH = 8;

  // Range Filter
  // Config: [period, multiplier] - e.g., "[100, 3.0]"
  // Defaults: period=100, multiplier=3.0
  // RawValue: {"filter": float64, "smooth_range": float64, "upward_count": float64, "downward_count": float64}
  INDICATOR_RANGE_FILTER = 9;

  // EMA (Exponential Moving Average)
  // Config: [period] - e.g., "[20]"
  // Defaults: period=20
  // RawValue: {"ema": float64} - EMA value
  INDICATOR_EMA = 10;

  // Waddah Attar Explosion
  // Config: [fastPeriod, slowPeriod, signalPeriod, atrPeriod, multiplier] - e.g., "[20, 40, 9, 14, 150.0]"
  // Defaults: fastPeriod=20, slowPeriod=40, signalPeriod=9, atrPeriod=14, multiplier=150.0
  // RawValue: {"macd": float64, "signal": float64, "histogram": float64, "atr": float64, "trend": float64, "explosion": float64}
  INDICATOR_WADDAH_ATTAR = 11;

  // ATR (Average True Range)
  // Config: [period] - e.g., "[14]"
  // Defaults: period=14
  // RawValue: {"atr": float64} - ATR value (volatility measure)
  INDICATOR_ATR = 12;

  // MA (Simple Moving Average)
  // Config: [period] - e.g., "[20]"
  // Defaults: period=20
  // RawValue: {"ma": float64} - MA value
  INDICATOR_MA = 13;
}

message GetRequest {
  string key = 1;
}

message GetResponse {
  string value = 1;
}

message SetRequest {
  string key = 1;
  string value = 2;
}

message PlaceMultipleOrdersRequest {
  repeated ExecuteOrder orders = 1;
}

message GetPositionsResponse {
  repeated Position positions = 1;
}

message GetPositionRequest {
  string symbol = 1;
}

message CancelOrderRequest {
  string order_id = 1;
}

message GetOrderStatusRequest {
  string order_id = 1;
}

message GetOrderStatusResponse {
  OrderStatus status = 1;
}

enum OrderStatus {
  ORDER_STATUS_PENDING = 0;
  ORDER_STATUS_FILLED = 1;
  ORDER_STATUS_CANCELLED = 2;
  ORDER_STATUS_REJECTED = 3;
  ORDER_STATUS_FAILED = 4;
}

enum PurchaseType {
  PURCHASE_TYPE_BUY = 0;
  PURCHASE_TYPE_SELL = 1;
}

enum OrderType {
  ORDER_TYPE_MARKET = 0;
  ORDER_TYPE_LIMIT = 1;
}

enum OrderReason {
  ORDER_REASON_STOP_LOSS = 0;
  ORDER_REASON_TAKE_PROFIT = 1;
  ORDER_REASON_STRATEGY = 2;
}

message Reason {
  string reason = 1;
  string message = 2;
}

message ExecuteOrderTakeProfitOrStopLoss {
  string symbol = 1;
  PurchaseType side = 2;
  OrderType order_type = 3;
}

message ExecuteOrder {
  string id = 1;
  string symbol = 2;
  PurchaseType side = 3;
  OrderType order_type = 4;
  Reason reason = 5;
  double price = 6;
  string strategy_name = 7;
  double quantity = 8;
  ExecuteOrderTakeProfitOrStopLoss take_profit = 9;
  ExecuteOrderTakeProfitOrStopLoss stop_loss = 10;
  PositionType position_type = 11;
}

message Order {
  string order_id = 1;
  string symbol = 2;
  PurchaseType side = 3;
  double quantity = 4;
  double price = 5;
  google.protobuf.Timestamp timestamp = 6;
  bool is_completed = 7;
  Reason reason = 8;
  string strategy_name = 9;
  double fee = 10;
  PositionType position_type = 11;
}

message Position {
  string symbol = 1;
  double quantity = 2;
  double total_in_quantity = 3;
  double total_out_quantity = 4;
  double total_in_amount = 5;
  double total_out_amount = 6;
  double total_in_fee = 7;
  double total_out_fee = 8;
  google.protobuf.Timestamp open_timestamp = 9;
  string strategy_name = 10;
}

message MarkRequest {
  MarketData market_data = 1;
  Mark mark = 2;
}

message GetMarkersResponse {
  repeated Mark markers = 1;
}

enum MarkShape {
  MARK_SHAPE_CIRCLE = 0;
  MARK_SHAPE_SQUARE = 1;
  MARK_SHAPE_TRIANGLE = 2;
}

enum MarkLevel {
  MARK_LEVEL_INFO = 0;
  MARK_LEVEL_WARNING = 1;
  MARK_LEVEL_ERROR = 2;
}

message Mark {
  // color of the mark.
  // Supported color strings are: red, green, blue, yellow, purple, orange
  // or hex color like #FF0000
  string color = 1;
  MarkShape shape = 2;
  string title = 3;
  string message = 4;
  string category = 5;
  SignalType signal_type = 6;
  // level of the mark (info, warning, error)
  MarkLevel level = 7;
}

// AccountInfo represents the current account state
message AccountInfo {
  double balance = 1;           // Cash balance
  double equity = 2;            // Total equity (balance + unrealized P&L)
  double buying_power = 3;      // Available for new purchases
  double realized_pnl = 4;      // Closed position profits/losses
  double unrealized_pnl = 5;    // Open position profits/losses
  double total_fees = 6;        // Total fees paid
  double margin_used = 7;       // Margin in use (for margin trading)
}

// GetOpenOrdersResponse contains all pending orders
message GetOpenOrdersResponse {
  repeated OpenOrder orders = 1;
}

// OpenOrder represents a pending order that has not been executed
message OpenOrder {
  string id = 1;
  string symbol = 2;
  PurchaseType side = 3;
  OrderType order_type = 4;
  double quantity = 5;
  double price = 6;
  string strategy_name = 7;
  PositionType position_type = 8;
  Reason reason = 9;
}

// GetTradesRequest contains filters for querying trade history
message GetTradesRequest {
  string symbol = 1;                          // Optional: filter by symbol
  google.protobuf.Timestamp start_time = 2;  // Optional: filter by time range
  google.protobuf.Timestamp end_time = 3;    // Optional: filter by time range
  int32 limit = 4;                           // Optional: limit results
}

// GetTradesResponse contains the list of executed trades
message GetTradesResponse {
  repeated TradeRecord trades = 1;
}

// TradeRecord represents an executed trade
message TradeRecord {
  string order_id = 1;
  string symbol = 2;
  PurchaseType side = 3;
  double quantity = 4;
  double price = 5;
  google.protobuf.Timestamp executed_at = 6;
  double fee = 7;
  double pnl = 8;
  PositionType position_type = 9;
  string strategy_name = 10;
  Reason reason = 11;
}

// LogLevel represents the severity of a log message
enum LogLevel {
  LOG_LEVEL_DEBUG = 0;
  LOG_LEVEL_INFO = 1;
  LOG_LEVEL_WARN = 2;
  LOG_LEVEL_ERROR = 3;
}

// LogRequest contains a log message from the strategy
message LogRequest {
  LogLevel level = 1;
  string message = 2;
  map<string, string> fields = 3;  // Optional structured fields
}

