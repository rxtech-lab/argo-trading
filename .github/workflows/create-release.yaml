name: Create Release
on:
  workflow_dispatch:

jobs:
  # Step 1: Determine the next version using semantic-release dry-run
  get-version:
    name: Get Next Version
    runs-on: blacksmith-4vcpu-ubuntu-2404
    outputs:
      version: v${{ steps.semantic.outputs.new_release_version }}
      release_notes: ${{ steps.semantic.outputs.new_release_notes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Get next version
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          dry_run: true
          extra_plugins: |
            @semantic-release/commit-analyzer
            @semantic-release/release-notes-generator
            @semantic-release/github
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  # Step 2: Build xcframework using reusable workflow
  build-xcframework:
    name: Build XCFramework
    needs: [get-version]
    uses: ./.github/workflows/build-xcframework.yml
    with:
      version: ${{ needs.get-version.outputs.version }}
    secrets:
      BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      SIGNING_CERTIFICATE_NAME: ${{ secrets.SIGNING_CERTIFICATE_NAME }}

  # Step 3: Build macOS binaries
  build-macos-binaries:
    name: Build macOS Binaries
    needs: [get-version]
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
          check-latest: true

      - name: Install dependencies
        run: go mod download

      - name: Install required tools
        run: ./scripts/setup.sh

      - name: Generate sdk and mocks
        run: make generate

      - name: Import code signing certificates
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}

      - name: Build the binary
        run: ./scripts/build.sh
        env:
          VERSION: ${{ needs.get-version.outputs.version }}

      - name: Sign the binary
        run: ./scripts/sign.sh
        env:
          SIGNING_CERTIFICATE_NAME: ${{ secrets.SIGNING_CERTIFICATE_NAME }}

      - name: Import installer certificates
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.INSTALLER_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}
          keychain: installer

      - name: Notarize the binary
        run: ./scripts/package-notarize.sh
        env:
          INSTALLER_SIGNING_CERTIFICATE_NAME: ${{ secrets.INSTALLER_SIGNING_CERTIFICATE_NAME }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PWD: ${{ secrets.APPLE_ID_PWD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries-${{ needs.get-version.outputs.version }}
          path: |
            output/trading-backtest
            ArgoTrading_macOS_arm64.pkg
          retention-days: 1

  # Step 4: Build Linux binaries
  build-linux-binaries:
    name: Build Linux Binaries
    needs: [get-version]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
          check-latest: true

      - name: Install dependencies
        run: go mod download

      - name: Setup
        run: ./scripts/setup.sh

      - name: Generate sdk and mocks
        run: make generate

      - name: Build the binary
        run: |
          mkdir -p output
          go build -o output/trading-backtest \
            -ldflags "-X main.Version=${{ needs.get-version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            ./cmd/backtest
          chmod +x output/trading-backtest

      - name: Create zip
        run: zip -j ArgoTrading_Linux_amd64.zip output/trading-backtest

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries-${{ needs.get-version.outputs.version }}
          path: ArgoTrading_Linux_amd64.zip
          retention-days: 1

  # Step 5: Create release with updated Package.swift
  create-release:
    name: Create Release
    needs: [get-version, build-xcframework, build-macos-binaries, build-linux-binaries]
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Download xcframework artifact
        uses: actions/download-artifact@v4
        with:
          name: xcframework-${{ needs.get-version.outputs.version }}

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries-${{ needs.get-version.outputs.version }}
          path: macos-binaries

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries-${{ needs.get-version.outputs.version }}

      - name: Update Package.swift
        run: |
          chmod +x scripts/update-package-swift.sh
          ./scripts/update-package-swift.sh "${{ needs.get-version.outputs.version }}" "${{ needs.build-xcframework.outputs.checksum }}"
          cat Package.swift

      - name: Setup SSH for deploy key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Create commit and tag
        run: |
          TAG="${{ needs.get-version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Configure git to use SSH
          git remote set-url origin git@github.com:${{ github.repository }}.git

          # Commit updated Package.swift
          git add Package.swift
          git commit -m "chore: update Package.swift for ${TAG}"

          # Create annotated tag
          git tag -a "${TAG}" -m "Release ${TAG}"

          # Push commit to main, then push tag
          git push origin HEAD:main
          git push origin "${TAG}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-version.outputs.version }}
          body: ${{ needs.get-version.outputs.release_notes }}
          files: |
            ArgoTrading.xcframework.zip
            macos-binaries/ArgoTrading_macOS_arm64.pkg
            ArgoTrading_Linux_amd64.zip
          token: ${{ secrets.GITHUB_TOKEN }}
